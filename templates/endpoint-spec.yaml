# Template: Endpoint Specification
# Location: spec/apis/NN-endpoint-name.yaml

# Endpoint metadata
endpoint: METHOD /api/endpoint-path
complexity: simple | medium | complex
streaming: false  # or true
status: draft | ready | implemented

# Feature flag that gates this endpoint
# Values: inference (default), model, tools
feature: inference

# Brief description
description: |
  What this endpoint does and when to use it.

# Request specification
request:
  type: EndpointRequest  # Rust type name

  fields:
    # Required field
    - name: model
      type: String
      required: true
      description: The model name to use

    # Optional field (with-method chain pattern)
    - name: prompt
      type: Option<String>
      required: false
      description: The input prompt
      default: null

    # Field with default
    - name: stream
      type: bool
      required: false
      description: Whether to stream the response
      default: false

    # Enum field
    - name: format
      type: Option<FormatSetting>
      required: false
      description: Output format
      values: [json, text]

    # Nested object
    - name: options
      type: Option<ModelOptions>
      required: false
      description: Model parameters
      nested:
        - name: temperature
          type: f32
          description: Sampling temperature

    # Feature-gated field (only present when feature is enabled)
    - name: tools
      type: Option<Vec<ToolDefinition>>
      required: false
      description: Tool definitions for function calling
      feature_gate: tools  # #[cfg(feature = "tools")]

  validation:
    - Model name must not be empty
    - Temperature must be between 0.0 and 2.0

  example: |
    {
      "model": "llama3",
      "prompt": "Hello, world!",
      "stream": false
    }

# Response specification
response:
  type: EndpointResponse  # Rust type name

  fields:
    - name: model
      type: String
      description: The model used

    - name: response
      type: String
      description: The generated text

    - name: done
      type: bool
      description: Whether generation is complete

    - name: context
      type: Option<Vec<i64>>
      description: Context tokens for continuation

  # Helper methods on response type
  helpers:
    - name: content
      return_type: Option<&str>
      description: Convenience accessor for response content

    - name: is_done
      return_type: bool
      description: Whether generation is complete

    - name: total_duration_ms
      return_type: Option<f64>
      description: Total duration in milliseconds (converted from nanoseconds)

    - name: tokens_per_second
      return_type: Option<f64>
      description: Calculated tokens per second metric

  example: |
    {
      "model": "llama3",
      "response": "Hello! How can I help you?",
      "done": true
    }

# Streaming response (if streaming: true)
streaming_response:
  type: EndpointChunk

  fields:
    - name: model
      type: String
      description: The model used

    - name: response
      type: String
      description: Partial response text

    - name: done
      type: bool
      description: Whether this is the final chunk

  example: |
    {"model":"llama3","response":"Hello","done":false}
    {"model":"llama3","response":"!","done":false}
    {"model":"llama3","response":"","done":true}

# Error responses
errors:
  - status: 400
    condition: Invalid request parameters
    example: |
      {"error": "model is required"}

  - status: 404
    condition: Model not found
    example: |
      {"error": "model 'unknown' not found"}

  - status: 500
    condition: Internal server error
    example: |
      {"error": "internal error"}

# Trait method definitions
# These define the methods on OllamaApiAsync and OllamaApiSync traits
trait_methods:
  async:
    name: endpoint_name              # Method name on OllamaApiAsync trait
    signature: "async fn endpoint_name(&self, request: &EndpointRequest) -> Result<EndpointResponse>"
  sync:
    name: endpoint_name_blocking     # Method name on OllamaApiSync trait (_blocking suffix)
    signature: "fn endpoint_name_blocking(&self, request: &EndpointRequest) -> Result<EndpointResponse>"
  # Retry helper used internally
  retry_helper: post_with_retry      # or get_with_retry, post_empty_with_retry, delete_empty_with_retry

# Endpoint constant
endpoint_constant: "Endpoints::ENDPOINT_NAME"  # From src/http/endpoints.rs

# Implementation notes
notes: |
  - Any special handling required
  - Edge cases to consider
  - Related endpoints

# Dependencies
depends_on: []  # List of endpoints this depends on
blocks: []      # List of endpoints blocked by this
